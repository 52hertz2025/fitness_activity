<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>师恩难忘·2025教师节健身福利</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
  --gold: #f5c542;
  --gold-light: #ffdd67;
  --gold-dark: #d4a02a;
  --green: #004d40;
  --green-light: #00695c;
  --green-dark: #00251a;
  --glass: rgba(255, 255, 255, 0.1);
  --glass-border: rgba(255, 255, 255, 0.25);
  --glass-hover: rgba(255, 255, 255, 0.2);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
}

html, body {
  height: 100%;
  overflow: hidden;
}

body {
  background: linear-gradient(135deg, var(--green) 0%, var(--green-dark) 100%);
  color: #fff;
  position: relative;
}

body::before {
  content: '';
  position: absolute;
  width: 200%;
  height: 200%;
  top: -50%;
  left: -50%;
  background: radial-gradient(circle, var(--gold) 0%, transparent 60%);
  animation: rotate 20s linear infinite;
  opacity: 0.1;
  z-index: -1;
}

@keyframes rotate {
  to { transform: rotate(360deg); }
}

#scroll-container {
  height: 100vh;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 20px;
  position: relative;
}

.container {
  width: 100%;
  max-width: 850px;
  background: var(--glass);
  backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border);
  border-radius: 28px;
  padding: 40px 30px;
  margin: 0 auto;
  position: relative;
  z-index: 2;
  box-shadow: 0 20px 50px rgba(0, 0, 0, 0.25);
  overflow: hidden;
}

.container::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 6px;
  background: linear-gradient(90deg, var(--gold), var(--green-light));
  border-radius: 28px 28px 0 0;
}

.head {
  text-align: center;
  margin-bottom: 30px;
  position: relative;
  padding-bottom: 20px;
}

.head::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 200px;
  height: 4px;
  background: linear-gradient(90deg, transparent, var(--gold), transparent);
  border-radius: 2px;
}

.head h1 {
  font-size: 52px;
  font-weight: 900;
  background: linear-gradient(45deg, #fff 30%, var(--gold-light) 70%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  letter-spacing: 1px;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  margin-bottom: 10px;
}

.head p {
  font-size: 22px;
  color: var(--gold-light);
  margin-top: 8px;
  font-weight: 300;
  letter-spacing: 1px;
}

.countdown-box {
  display: flex;
  gap: 20px;
  justify-content: center;
  margin-bottom: 40px;
  flex-wrap: wrap;
}

.count-card {
  background: linear-gradient(145deg, rgba(0,77,64,0.4), rgba(0,37,26,0.6));
  border: 1px solid var(--gold);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
  border-radius: 16px;
  padding: 18px 12px;
  width: 100px;
  text-align: center;
  transition: all 0.3s ease;
}

.count-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
  background: linear-gradient(145deg, rgba(0,77,64,0.5), rgba(0,37,26,0.7));
}

.count-num {
  font-size: 36px;
  font-weight: 800;
  color: var(--gold-light);
  text-shadow: 0 0 10px rgba(245, 197, 66, 0.3);
}

.count-label {
  font-size: 14px;
  opacity: 0.85;
  letter-spacing: 1px;
  margin-top: 5px;
}

.price-box {
  display: flex;
  gap: 25px;
  justify-content: center;
  margin-bottom: 40px;
  flex-wrap: wrap;
}

.price-card {
  background: linear-gradient(145deg, rgba(0,77,64,0.4), rgba(0,37,26,0.6));
  border: 1px solid var(--glass-border);
  border-radius: 18px;
  padding: 25px;
  text-align: center;
  flex: 1 1 250px;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.price-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
}

.price-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 5px;
  background: var(--gold);
}

.price-card del {
  font-size: 20px;
  opacity: 0.7;
  color: rgba(255, 255, 255, 0.8);
}

.price-card strong {
  font-size: 42px;
  color: var(--gold-light);
  display: block;
  margin: 10px 0;
  text-shadow: 0 0 15px rgba(245, 197, 66, 0.4);
}

.price-card small {
  font-size: 14px;
  opacity: 0.9;
  display: block;
  margin-top: 10px;
}

.price-card:nth-child(2) {
  background: linear-gradient(145deg, rgba(197, 156, 51, 0.15), rgba(0,77,64,0.4));
  border: 1px solid var(--gold);
}

.price-card:nth-child(2) strong {
  font-size: 32px;
}

.benefit {
  background: rgba(0, 0, 0, 0.25);
  border-left: 4px solid var(--gold);
  padding: 25px;
  border-radius: 12px;
  margin-bottom: 35px;
  position: relative;
  overflow: hidden;
}

.benefit::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: radial-gradient(circle at top right, transparent, rgba(255, 255, 255, 0.05));
  pointer-events: none;
}

.benefit h4 {
  color: var(--gold-light);
  margin-bottom: 15px;
  font-size: 20px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.benefit h4 i {
  font-size: 24px;
}

.benefit p {
  line-height: 1.8;
  margin-bottom: 15px;
  padding-left: 34px;
  opacity: 0.9;
}

.gift {
  display: flex;
  align-items: center;
  gap: 20px;
  margin-bottom: 35px;
  background: linear-gradient(145deg, rgba(0,77,64,0.4), rgba(0,37,26,0.6));
  border-radius: 18px;
  padding: 20px;
  border: 1px solid var(--glass-border);
}

.gift img {
  width: 120px;
  border-radius: 12px;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
  animation: float 3s ease-in-out infinite;
}

@keyframes float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-15px); }
}

.gift-content {
  flex: 1;
}

.gift-content div:first-child {
  font-size: 22px;
  color: var(--gold-light);
  font-weight: 700;
  margin-bottom: 8px;
}

.gift-content div:last-child {
  font-size: 16px;
  opacity: 0.9;
  line-height: 1.6;
}

.address {
  text-align: center;
  margin-bottom: 35px;
}

.address button {
  background: linear-gradient(145deg, var(--gold), var(--gold-dark));
  color: var(--green);
  border: none;
  padding: 14px 32px;
  border-radius: 50px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 18px;
  box-shadow: 0 5px 15px rgba(245, 197, 66, 0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  margin: 0 auto;
}

.address button:hover {
  background: linear-gradient(145deg, var(--gold-light), var(--gold));
  transform: translateY(-3px);
  box-shadow: 0 8px 20px rgba(245, 197, 66, 0.4);
}

.address button:active {
  transform: translateY(1px);
}

.form-section {
  background: rgba(0, 0, 0, 0.3);
  border-radius: 18px;
  padding: 30px;
  border: 1px solid var(--glass-border);
}

.form-section h3 {
  text-align: center;
  font-size: 28px;
  margin-bottom: 25px;
  color: var(--gold-light);
  position: relative;
  padding-bottom: 15px;
}

.form-section h3::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 150px;
  height: 3px;
  background: linear-gradient(90deg, transparent, var(--gold), transparent);
  border-radius: 3px;
}

.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  font-size: 16px;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 8px;
}

.form-group label.required::after {
  content: '*';
  color: var(--gold);
  margin-left: 4px;
}

.form-group input,
.form-group select {
  width: 100%;
  padding: 14px 18px;
  border: 1px solid var(--glass-border);
  border-radius: 12px;
  background: rgba(0, 0, 0, 0.2);
  color: #fff;
  font-size: 16px;
  transition: all 0.3s ease;
}

.form-group input:focus,
.form-group select:focus {
  outline: none;
  border-color: var(--gold);
  box-shadow: 0 0 0 3px rgba(245, 197, 66, 0.2);
  background: rgba(0, 0, 0, 0.3);
}

.form-group input::placeholder {
  color: rgba(255, 255, 255, 0.5);
}

.upload-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 12px 20px;
  background: linear-gradient(145deg, var(--gold), var(--gold-dark));
  color: var(--green);
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  margin-top: 10px;
  transition: all 0.3s ease;
}

.upload-btn:hover {
  background: linear-gradient(145deg, var(--gold-light), var(--gold));
  transform: translateY(-2px);
}

.upload-name {
  font-size: 14px;
  margin-top: 10px;
  color: rgba(255, 255, 255, 0.8);
  padding-left: 10px;
}

.qr-container {
  text-align: center;
  margin: 15px 0;
}

.qr-container p {
  margin-bottom: 10px;
  font-weight: 500;
  color: var(--gold-light);
}

#payQr {
  width: 180px;
  height: 180px;
  display: block;
  margin: 0 auto 15px;
  border-radius: 12px;
  border: 1px solid var(--glass-border);
  background: white;
  padding: 10px;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
}

.submit-btn {
  width: 100%;
  padding: 18px;
  background: linear-gradient(145deg, var(--gold), var(--gold-dark));
  color: var(--green);
  border: none;
  border-radius: 12px;
  font-size: 18px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
  margin-top: 10px;
  letter-spacing: 1px;
  box-shadow: 0 5px 15px rgba(245, 197, 66, 0.3);
}

.submit-btn:hover {
  background: linear-gradient(145deg, var(--gold-light), var(--gold));
  transform: translateY(-3px);
  box-shadow: 0 8px 20px rgba(245, 197, 66, 0.4);
}

.submit-btn:active {
  transform: translateY(1px);
}

.toast {
  position: fixed;
  top: 30px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0, 0, 0, 0.9);
  color: var(--gold-light);
  padding: 16px 32px;
  border-radius: 12px;
  display: none;
  z-index: 999;
  font-weight: bold;
  box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
  border: 1px solid var(--gold);
  animation: fadeInOut 0.3s ease;
}

@keyframes fadeInOut {
  0% { opacity: 0; transform: translate(-50%, -20px); }
  100% { opacity: 1; transform: translate(-50%, 0); }
}

@media (max-width: 768px) {
  .head h1 { font-size: 42px; }
  .head p { font-size: 18px; }
  .count-card { width: 80px; padding: 15px 10px; }
  .count-num { font-size: 32px; }
  .price-card { flex: 1 1 100%; }
  .gift { flex-direction: column; text-align: center; }
  .gift img { width: 140px; }
  .address button { width: 100%; max-width: 300px; }
}

@media (max-width: 480px) {
  #scroll-container { padding: 10px; }
  .container { padding: 25px 15px; }
  .head h1 { font-size: 36px; }
  .count-card { width: 70px; }
  .count-num { font-size: 28px; }
  .benefit { padding: 20px 15px; }
  .benefit p { padding-left: 0; }
  .form-section { padding: 20px 15px; }
  .submit-btn { padding: 16px; font-size: 16px; }
}

/* 滚动条样式 */
#scroll-container::-webkit-scrollbar {
  width: 8px;
}

#scroll-container::-webkit-scrollbar-track {
  background: rgba(0, 0, 0, 0.1);
}

#scroll-container::-webkit-scrollbar-thumb {
  background: var(--gold);
  border-radius: 4px;
}

/* 浮动装饰元素 */
.deco {
  position: absolute;
  z-index: 1;
  opacity: 0.1;
}

.deco-1 {
  top: 5%;
  left: 5%;
  width: 60px;
  height: 60px;
  border: 2px solid var(--gold);
  border-radius: 50%;
  animation: pulse 4s infinite alternate;
}

.deco-2 {
  bottom: 10%;
  right: 7%;
  width: 40px;
  height: 40px;
  border: 2px solid var(--gold);
  border-radius: 50%;
  animation: pulse 3s 1s infinite alternate;
}

.deco-3 {
  top: 15%;
  right: 10%;
  width: 30px;
  height: 30px;
  border: 2px solid var(--gold);
  transform: rotate(45deg);
  animation: rotate 20s linear infinite reverse;
}

@keyframes pulse {
  0% { transform: scale(1); opacity: 0.1; }
  100% { transform: scale(1.2); opacity: 0.2; }
}
</style>
</head>
<body>
<!-- 装饰元素 -->
<div class="deco deco-1"></div>
<div class="deco deco-2"></div>
<div class="deco deco-3"></div>

<!-- 滚动容器 -->
<div id="scroll-container">
  <div class="container">
    <div class="head">
      <h1>师恩难忘</h1>
      <p>致敬师者·健康同行 | 2025 教师节专属健身福利卡</p>
    </div>

    <!-- 倒计时 -->
    <div class="countdown-box" id="countdown"></div>

    <!-- 价格卡片 -->
    <div class="price-box">
      <div class="price-card">
        <del>原价 1839 元</del>
        <strong>985 元</strong>
        <small>教师节当天仅此一次</small>
      </div>
      <div class="price-card">
        <strong>前 5 名</strong>
        <div>送价值 300 元</div>
        <div>一米二羊驼凳</div>
      </div>
    </div>

    <!-- 福利清单 -->
    <div class="benefit">
      <h4><i class="fas fa-calendar-alt"></i>活动时间</h4>
      <p>2025 年 9 月 10 日（教师节当天）<br>凭教师资格证 / 学校工作证明参与</p>

      <h4><i class="fas fa-gift"></i>当天免费畅练</h4>
      <p>全天免费健身（器械区 + 团课）<br>专业教练现场「教师专属体态评估」1 次</p>

      <h4><i class="fas fa-map-marker-alt"></i>地址 & 电话</h4>
      <p>会宁颐园水景广场商业街 2 楼<br>电话：0943-3256546</p>
    </div>

    <!-- 羊驼凳 -->
    <div class="gift">
      <img src="https://img0.baidu.com/it/u=2836893172,415776004&fm=253&app=138&f=JPEG?w=500&h=500" alt="羊驼凳">
      <div class="gift-content">
        <div>限量羊驼凳</div>
        <div>前 5 名到手！软萌治愈，健身也能可可爱爱~</div>
      </div>
    </div>

    <!-- 一键导航 -->
    <div class="address">
      <button onclick="openMap()">
        <i class="fas fa-map-marked-alt"></i>一键导航到店
      </button>
    </div>

    <!-- 报名表单 -->
    <div class="form-section">
      <h3>教师专属报名通道</h3>
      <form id="form">
        <div class="form-group">
          <label class="required"><i class="fas fa-user"></i>姓名</label>
          <input type="text" name="name" placeholder="请输入姓名" required>
        </div>
        <div class="form-group">
          <label class="required"><i class="fas fa-mobile-alt"></i>手机号</label>
          <input type="tel" name="phone" placeholder="11 位手机号" maxlength="11" required>
        </div>
        <div class="form-group">
          <label><i class="fas fa-dumbbell"></i>推荐教练</label>
          <select name="coach">
            <option value="">请选择（可选）</option>
            <option>武教练</option>
            <option>蔺教练</option>
            <option>周教练</option>
            <option>陈教练</option>
            <option>任教练</option>
          </select>
        </div>
        <div class="form-group">
          <label class="required"><i class="fas fa-certificate"></i>教师资格证 / 工作证明</label>
          <input type="file" name="cert" id="cert" accept="image/*" required>
          <label for="cert" class="upload-btn">
            <i class="fas fa-upload"></i>选择文件
          </label>
          <div id="certName" class="upload-name"></div>
        </div>
        <div class="form-group">
          <label><i class="fas fa-qrcode"></i>支付二维码</label>
          <div class="qr-container">
            <p>扫码支付后上传截图</p>
            <img id="payQr" src="" alt="支付二维码">
          </div>
          <label><i class="fas fa-file-image"></i>支付截图</label>
          <input type="file" name="payPic" id="payPic" accept="image/*">
          <label for="payPic" class="upload-btn">
            <i class="fas fa-upload"></i>选择支付截图
          </label>
          <div id="payName" class="upload-name"></div>
        </div>
        <button type="submit" class="submit-btn">
          <i class="fas fa-lock"></i>立即锁定福利
        </button>
      </form>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ===== Supabase 初始化 ===== */
const _supabase = supabase.createClient(
  'https://felxoutuqbkwitzcmdvo.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZlbHhvdXR1cWJrd2l0emNtZHZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcxNDUxNTAsImV4cCI6MjA3MjcyMTE1MH0.SATJ4P-quvK8Y_jPVGipRc8s2GCZBRktV9r_XnzM730'
);

/* ===== 实时拉库 → 动态收款码 + 倒计时 ===== */
(async()=>{
  try {
    const {data,error}=await _supabase.from('activity_config').select('*').single();
    if(error) throw error;

    const supabaseProjectId = 'felxoutu<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>活动管理 - 52hertz</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body{background:#0f172a;color:#e2e8f0;padding:20px;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;}
h2{text-align:center;margin-bottom:20px;color:#7dd3fc;}
.wrap{max-width:1200px;margin:auto;background:rgba(15,23,42,.7);backdrop-filter:blur(12px);border-radius:12px;padding:20px;border:1px solid rgba(56,189,248,.2);}
.toolbar{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap;}
.toolbar input,.toolbar select{padding:8px 10px;border-radius:6px;border:1px solid rgba(56,189,248,.3);background:rgba(8,47,73,.5);color:#e2e8f0;}
button{padding:8px 14px;border:none;border-radius:6px;background:#0ea5e9;color:#fff;cursor:pointer;}button:hover{background:#0284c7;}
table{width:100%;border-collapse:collapse;font-size:14px;}th,td{padding:10px;border:1px solid rgba(56,189,248,.2);text-align:center;}
th{background:rgba(8,47,73,.7);color:#7dd3fc;}tr:nth-child(even){background:rgba(8,47,73,.3);}
.actions button{margin:0 4px;padding:4px 8px;font-size:12px;} .btn-confirm{background:#22c55e;} .btn-edit{background:#0ea5e9;} .btn-del{background:#ef4444;}
.pagination{display:flex;justify-content:center;gap:8px;margin-top:15px;}
.toast{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(15,23,42,.9);color:#e2e8f0;padding:12px 20px;border-radius:8px;display:none;z-index:999;backdrop-filter:blur(10px);border:1px solid rgba(56,189,248,.3);}

/* 新增样式 */
.payment-section {
  background: rgba(8, 47, 73, 0.5);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
  border: 1px solid rgba(56, 189, 248, 0.3);
}

.payment-section h3 {
  color: #7dd3fc;
  margin-bottom: 15px;
  text-align: center;
}

.qr-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 15px;
}

#currentQr {
  max-width: 200px;
  border: 1px solid rgba(56, 189, 248, 0.3);
  border-radius: 8px;
}

.upload-controls {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
}

#newQrPreview {
  max-width: 200px;
  display: none;
  border: 1px solid rgba(56, 189, 248, 0.3);
  border-radius: 8px;
}
</style>
</head>
<body>
<div class="wrap">
  <h2>教师节活动报名管理</h2>

  <!-- 新增付款码管理区域 -->
  <div class="payment-section">
    <h3>付款码管理</h3>
    <div class="qr-container">
      <div>当前付款码:</div>
      <img id="currentQr" src="" alt="当前付款码">
      <div class="upload-controls">
        <input type="file" id="newQrFile" accept="image/*" style="display: none;">
        <button id="uploadQrBtn">上传新付款码</button>
        <img id="newQrPreview" alt="新付款码预览">
        <button id="saveQrBtn" style="display: none; background: #22c55e;">保存付款码</button>
      </div>
    </div>
  </div>

  <div class="toolbar">
    <input id="search" placeholder="姓名 / 手机号">
    <select id="filterCoach"><option value="">全部教练</option><option>武教练</option><option>蔺教练</option><option>周教练</option><option>陈教练</option><option>任教练</option></select>
    <select id="filterStatus"><option value="">全部状态</option><option value="0">待确认</option><option value="1">已确认</option></select>
    <button id="btnSearch">查询</button><button id="btnExport">导出CSV</button>
  </div>
  <table><thead>
    <tr><th>姓名</th><th>手机号</th><th>教练</th><th>报名时间</th><th>状态</th><th>支付截图</th><th>操作</th></tr>
  </thead><tbody id="tbody"></tbody></table>
  <div class="pagination" id="pagination"></div>
</div>
<div class="toast" id="toast"></div>

<script>
const _supabase = supabase.createClient(
  'https://felxoutuqbkwitzcmdvo.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZlbHhvdXR1cWJrd2l0emNtZHZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcxNDUxNTAsImV4cCI6MjA3MjcyMTE1MH0.SATJ4P-quvK8Y_jPVGipRc8s2GCZBRktV9r_XnzM730'
);
let page=1,pageSize=20,total=0;
const searchEl=document.getElementById('search'),coachEl=document.getElementById('filterCoach'),statusEl=document.getElementById('filterStatus');

// 新增付款码相关元素
const currentQrEl = document.getElementById('currentQr');
const newQrFileEl = document.getElementById('newQrFile');
const uploadQrBtnEl = document.getElementById('uploadQrBtn');
const newQrPreviewEl = document.getElementById('newQrPreview');
const saveQrBtnEl = document.getElementById('saveQrBtn');

// 初始化页面时加载当前付款码
async function loadPaymentQr() {
  try {
    const { data, error } = await _supabase
      .from('activity_config')
      .select('pay_qr')
      .single();

    if (error) throw error;

    const supabaseProjectId = 'felxoutuqbkwitzcmdvo';
    const bucketName = 'photo';
    const supabasePublicPrefix = `https://${supabaseProjectId}.supabase.co/storage/v1/object/public/${bucketName}/`;

    // 设置当前付款码图片URL（添加时间戳以避免缓存）
    currentQrEl.src = `${supabasePublicPrefix}${data.pay_qr}?t=${Date.now()}`;
    currentQrEl.onerror = () => {
      currentQrEl.src = 'data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 24 24"><rect fill="%23ccc" width="24" height="24"/><text x="12" y="16" font-family="Arial" font-size="10" text-anchor="middle" fill="%23666">付款码加载失败</text></svg>';
    };
  } catch (error) {
    showToast('加载付款码失败: ' + error.message);
  }
}

// 上传新付款码按钮点击事件
uploadQrBtnEl.addEventListener('click', () => {
  newQrFileEl.click();
});

// 文件选择后预览
newQrFileEl.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = (event) => {
      newQrPreviewEl.src = event.target.result;
      newQrPreviewEl.style.display = 'block';
      saveQrBtnEl.style.display = 'block';
    };
    reader.readAsDataURL(file);
  }
});

// 保存新付款码
saveQrBtnEl.addEventListener('click', async () => {
  const file = newQrFileEl.files[0];
  if (!file) return showToast('请先选择图片文件');

  try {
    showToast('正在上传新付款码...');

    // 删除旧的付款码文件（可选）
    const { data: configData, error: configError } = await _supabase
      .from('activity_config')
      .select('pay_qr')
      .single();

    if (configError) throw configError;

    // 上传新文件
    const fileName = `pay_qr_${Date.now()}.png`;
    const { error: uploadError } = await _supabase
      .storage
      .from('photo')
      .upload(fileName, file, {
        upsert: true
      });

    if (uploadError) throw uploadError;

    // 更新数据库中的文件名
    const { error: updateError } = await _supabase
      .from('activity_config')
      .update({ pay_qr: fileName })
      .eq('id', 1); // 假设配置表中只有一条记录

    if (updateError) throw updateError;

    // 更新页面显示
    const supabaseProjectId = 'felxoutuqbkwitzcmdvo';
    const bucketName = 'photo';
    const supabasePublicPrefix = `https://${supabaseProjectId}.supabase.co/storage/v1/object/public/${bucketName}/`;
    currentQrEl.src = `${supabasePublicPrefix}${fileName}?t=${Date.now()}`;

    // 重置上传控件
    newQrFileEl.value = '';
    newQrPreviewEl.style.display = 'none';
    saveQrBtnEl.style.display = 'none';

    showToast('付款码更新成功');
  } catch (error) {
    showToast('更新失败: ' + error.message);
  }
});

async function fetchData(){
  let query=_supabase.from('teacher_reg').select('*',{count:'exact'}).order('created_at',{ascending:false}).range((page-1)*pageSize,page*pageSize-1);
  const kw=searchEl.value.trim();
  if(kw)query=query.or(`name.ilike.%${kw}%,phone.ilike.%${kw}%`);
  if(coachEl.value)query=query.eq('coach',coachEl.value);
  if(statusEl.value!=='')query=query.eq('confirmed',parseInt(statusEl.value));
  const {data,count,error}=await query;
  if(error)return showToast('读取失败');
  total=count;renderTable(data);renderPage();
}

function renderTable(rows){
  document.getElementById('tbody').innerHTML=rows.map(r=>`
    <tr>
      <td>${r.name}</td><td>${r.phone}</td><td>${r.coach||'-'}</td>
      <td>${new Date(r.created_at).toLocaleString('zh-CN')}</td>
      <td>${r.confirmed?'已确认':'待确认'}</td>
      <td>${r.pay_proof?`<button onclick="viewProof('${r.pay_proof}')">查看</button>`:`-`}</td>
      <td class="actions">
        ${!r.confirmed?`<button class="btn-confirm" onclick="confirmRow('${r.id}')">确认</button>`:''}
        <button class="btn-edit" onclick="editRow('${r.id}','${r.name}','${r.phone}','${r.coach}')">编辑</button>
        <button class="btn-del" onclick="delRow('${r.id}')">删除</button>
      </td>
    </tr>`).join('');
}

function renderPage(){
  const pages=Math.ceil(total/pageSize);
  let html='';
  for(let i=1;i<=pages;i++)html+=`<button class="${i===page?'active':''}" onclick="goPage(${i})">${i}</button>`;
  document.getElementById('pagination').innerHTML=html;
}

function goPage(p){page=p;fetchData();}

async function confirmRow(id){
  const {error}=await _supabase.from('teacher_reg').update({confirmed:true}).eq('id',id);
  if(error)return showToast('确认失败');showToast('已确认');fetchData();
}

async function editRow(id,n,p,c){
  const name=prompt('姓名',n),phone=prompt('手机号',p),coach=prompt('教练',c||'');
  if(name===null||phone===null)return;
  if(!name.trim()||!phone.trim())return showToast('姓名和手机号必填');
  const {error}=await _supabase.from('teacher_reg').update({name:name.trim(),phone:phone.trim(),coach:coach.trim()}).eq('id',id);
  if(error)return showToast('更新失败');showToast('已更新');fetchData();
}

async function delRow(id){
  if(!confirm('确定删除？'))return;
  const {error}=await _supabase.from('teacher_reg').delete().eq('id',id);
  if(error)return showToast('删除失败');showToast('已删除');fetchData();
}

function viewProof(path){
  const url=`https://felxoutuqbkwitzcmdvo.supabase.co/storage/v1/object/public/photo/${path}`;
  window.open(url,'_blank','width=800,height=600');
}

document.getElementById('btnSearch').onclick=()=>{page=1;fetchData();};

document.getElementById('btnExport').onclick=async()=>{
  const {data,error}=await _supabase.from('teacher_reg').select('*').order('created_at',{ascending:false});
  if(error)return showToast('导出失败');
  const csv=['姓名,手机号,教练,报名时间,状态,支付截图路径'].concat(data.map(r=>[r.name,r.phone,r.coach||'-',new Date(r.created_at).toLocaleString('zh-CN'),r.confirmed?'已确认':'待确认',r.pay_proof||''].join(','))).join('\n');
  const blob=new Blob(['\ufeff'+csv],{type:'text/csv;charset=utf-8;'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='teacher_reg_'+new Date().toISOString().slice(0,10)+'.csv';a.click();URL.revokeObjectURL(url);
};

function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg;
  t.style.display='block';
  setTimeout(()=>t.style.display='none',2000);
}

// 页面加载时初始化
loadPaymentQr();
fetchData();
</script>
</body>
</html>
qbkwitzcmdvo'; // 你的项目ID
    const bucketName = 'photo'; // 你的桶名
    const supabasePublicPrefix = `https://${supabaseProjectId}.supabase.co/storage/v1/object/public/${bucketName}/`;
    // 动态设置收款码（正确URL：前缀+文件名+时间戳）
    document.getElementById('payQr').src = `${supabasePublicPrefix}${data.pay_qr}?t=${Date.now()}`;


    // 倒计时到 2025-09-10 23:59:59
    startCount(new Date('2025-09-10T23:59:59'));
  } catch(error) {
    showToast('读取活动失败: ' + error.message);
  }
})();

/* ===== 倒计时 ===== */
function startCount(end){
  updateCount(); // 立即更新一次
  setInterval(updateCount, 1000);

  function updateCount() {
    const d = Math.max(0, end - new Date());
    const days = Math.floor(d / 864e5);
    const hrs = Math.floor(d % 864e5 / 36e5);
    const min = Math.floor(d % 36e5 / 6e4);
    const sec = Math.floor(d % 6e4 / 1e3);

    document.getElementById('countdown').innerHTML = `
      <div class="count-card">
        <div class="count-num">${String(days).padStart(2, '0')}</div>
        <div class="count-label">天</div>
      </div>
      <div class="count-card">
        <div class="count-num">${String(hrs).padStart(2, '0')}</div>
        <div class="count-label">时</div>
      </div>
      <div class="count-card">
        <div class="count-num">${String(min).padStart(2, '0')}</div>
        <div class="count-label">分</div>
      </div>
      <div class="count-card">
        <div class="count-num">${String(sec).padStart(2, '0')}</div>
        <div class="count-label">秒</div>
      </div>
    `;
  }
}

/* ===== 导航 ===== */
function openMap(){
  window.open('https://uri.amap.com/search?keyword=会宁颐园水景广场商业街2楼','_blank');
}

/* ===== 文件回显 ===== */
document.getElementById('cert').onchange = e => {
  document.getElementById('certName').textContent = e.target.files[0]?.name || '';
};

document.getElementById('payPic').onchange = e => {
  document.getElementById('payName').textContent = e.target.files[0]?.name || '';
};

/* ===== 提交表单 ===== */
document.getElementById('form').onsubmit = async e => {
  e.preventDefault();

  const name = document.querySelector('input[name="name"]').value.trim();
  const phone = document.querySelector('input[name="phone"]').value;
  const certFile = document.querySelector('input[name="cert"]').files[0];
  const payFile = document.querySelector('input[name="payPic"]').files[0];

  // 表单验证
  if (!name) return showToast('请输入姓名');
  if (!/^1[3-9]\d{9}$/.test(phone)) return showToast('手机号格式错误');
  if (!certFile) return showToast('请上传资格证');
  if (!payFile) return showToast('请上传支付截图');

  showToast('正在提交，请稍候...');

  try {
    // 上传资格证
    const certPath = `cert/${Date.now()}_${certFile.name}`;
    const { error: certError } = await _supabase.storage
      .from('photo')
      .upload(certPath, certFile);

    if (certError) throw new Error('资格证上传失败: ' + certError.message);

    // 上传支付截图
    const payPath = `pay/${Date.now()}_${payFile.name}`;
    const { error: payError } = await _supabase.storage
      .from('photo')
      .upload(payPath, payFile);

    if (payError) throw new Error('支付截图上传失败: ' + payError.message);

    // 表单数据写入数据库
    const coach = document.querySelector('select[name="coach"]').value;
    const { error: dbError } = await _supabase.from('teacher_reg').insert({
      name: name,
      phone: phone,
      coach: coach,
      cert_proof: certPath,
      pay_proof: payPath
    });

    if (dbError) throw new Error('数据库写入失败: ' + dbError.message);

    showToast('锁定成功！客服将在24h内联系您');

    // 重置表单
    e.target.reset();
    document.getElementById('certName').textContent = '';
    document.getElementById('payName').textContent = '';

  } catch (error) {
    showToast(`提交失败: ${error.message}`);
    console.error(error);
  }
};

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.display = 'block';

  setTimeout(() => {
    t.style.display = 'none';
  }, 3000);
}

// 添加简单动画效果
document.addEventListener('DOMContentLoaded', () => {
  const container = document.querySelector('.container');
  container.style.opacity = '0';
  container.style.transform = 'translateY(20px)';

  setTimeout(() => {
    container.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
    container.style.opacity = '1';
    container.style.transform = 'translateY(0)';
  }, 100);

  // 滚动修复：确保滚动容器初始化
  const scrollContainer = document.getElementById('scroll-container');
  scrollContainer.scrollTop = 0;
});
</script>
</body>
</html>